# Develop Windows Store Apps

## Create Background Tasks

* A background task implements the `IBackgroundTask` interface, which defines a `Run` method with the signature 
```
public void Run(IBackgroundTaskInstance taskInstance)
```
* You can later use this task with the `BackgroundTaskBuilder` class:
```
var builder = new BackgroundTaskBuilder();
builder.Name = taskName;
builder.TaskEntryPoint = "BikeGPS.BikePositionUpdateBackgroundTask";
```
* Also, you need to set a trigger for when the background task will run:
```
builder.SetTrigger(new SystemTrigger(SystemTriggerType.TimeZoneChange, false));
```
* Possible triggers are `Invalid, SMSReceived, UserAway, NetworkStateChange, ControlChannelReset, InternetAvailable, SessionConnected, ServicingComplete, LockScreenApplicationRemoved, TimeZoneChange, OnlineIdConnectedStateChange`
* An application that registers a background task needs to declare the feature as an extension in the application manifest. The extension section needs to be inserted as a child of the Application tag.
```
<Extensions>
 <Extension Category="windows.backgroundTasks" EntryPoint="Namespace.MyBackgroundTask">
  <BackgroundTasks>
   <Task Type="systemEvent" />
  </BackgroundTasks>
 </Extension>
</Extensions>
```
* The Visual Studio App Manifest Designer can also be used to add a Background Tasks declaration, the details of which can then be edited in a graphical interface.
* To check if a task is active, one can look for it by name through the `BackgroundTaskRegistration.AllTasks` enumerable. An individual item's `task.Value.Name` property can be compared to the locally stored task name.
* For tasks that perform asynchronous work, the Run method needs to return a deferral
```
public async void Run(IBackgroundTaskInstance taskInstance)
{
 BackgroundTaskDeferral _deferral = taskInstance.GetDeferral();

 await MyWorkMethodAsync();
 _deferral.Complete();
}
```
## Consume Background Tasks

* Tasks respond to different kinds of triggers. These can be
 * `MaintenanceTrigger` - raised when it's time to execute system maintenance tasks
 * `SystemEventTrigger` - raised when a specific system event occurs
* Both of these types of triggers implement the `IBackgroundTask` interface
* A `MaintenanceTrigger` is created via
```
var myTrigger = new MaintenanceTrigger(60, true)
```
 * The first parameter is the freshness time, expressed in minutes
 * The second parameter indicates if the trigger should fire only once, or on every freshness time occurence

* For a `SystemEventTrigger`, whenever a system event occurs, we can check if specific conditions are met to see if our background task should be performed. These conditions are listed in the `SystemConditionType` enum
 * `InternetAvailable`
 * `InternetNotAvailable`
 * `SessionConnected`
 * `SessionNotConnected`
 * `UserNotPresent`
 * `UserPresent`
